generator client {
	provider = "prisma-client-js"
	output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
	id            String    @id @default(cuid())
	name          String?
	email         String    @unique
	emailVerified DateTime?
	password      String?
	image         String?
	createdAt     DateTime  @default(now())
	updatedAt     DateTime  @updatedAt
	
	accounts       Account[]
	sessions       Session[]
	doctorProfile  DoctorProfile?
	patients       Patient[]
	treatmentPlans TreatmentPlan[]
	
	@@map("users")
}

model Account {
	id                String  @id @default(cuid())
	userId            String
	type              String
	provider          String
	providerAccountId String
	refresh_token     String?
	access_token      String?
	expires_at        Int?
	token_type        String?
	scope             String?
	id_token          String?
	session_state     String?
	
	user User @relation(fields: [userId], references: [id], onDelete: Cascade)
	
	@@unique([provider, providerAccountId])
	@@map("accounts")
}

model Session {
	id           String   @id @default(cuid())
	sessionToken String   @unique
	userId       String
	expires      DateTime
	user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
	
	@@map("sessions")
}

model VerificationToken {
	identifier String
	token      String   @unique
	expires    DateTime
	
	@@unique([identifier, token])
	@@map("verification_tokens")
}

model DoctorProfile {
	id                    String   @id @default(cuid())
	userId                String   @unique
	user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
	
	fullName              String
	medicalLicenseNumber  String   @unique
	specialty             String
	phoneNumber           String
	isVerified            Boolean  @default(false)
	
	createdAt             DateTime @default(now())
	updatedAt             DateTime @updatedAt
	
	@@map("doctor_profiles")
}

model Patient {
	id                 String   @id @default(cuid())
	doctorId           String
	doctor             User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)
	
	name               String
	dateOfBirth        DateTime
	gender             Gender
	weight             Float?
	height             Float?
	bloodType          String?
	medicalHistory     String?
	currentMedications String[] @default([])
	allergies          String[] @default([])
	chronicConditions  String[] @default([])
	
	createdAt          DateTime @default(now())
	updatedAt          DateTime @updatedAt
	
	treatmentPlans     TreatmentPlan[]
	
	@@index([doctorId])
	@@map("patients")
}

model TreatmentPlan {
	id                  String     @id @default(cuid())
	patientId           String
	patient             Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
	doctorId            String
	doctor              User       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
	
	chiefComplaint      String
	currentSymptoms     String
	vitalSigns          Json?
	physicalExamNotes   String?
	
	aiRecommendations   Json?
	finalPlan           Json?
	
	riskLevel           RiskLevel?
	riskFactors         String[]   @default([])
	riskJustification   String?
	
	drugInteractions    Json[]     @default([])
	contraindications   Json[]     @default([])
	alternatives        Json[]     @default([])
	
	status              PlanStatus @default(DRAFT)
	wasModified         Boolean    @default(false)
	modificationNotes   String?
	
	createdAt           DateTime   @default(now())
	updatedAt           DateTime   @updatedAt
	approvedAt          DateTime?
	
	@@index([patientId])
	@@index([doctorId])
	@@index([status])
	@@index([createdAt])
	@@map("treatment_plans")
}

enum Gender {
	MALE
	FEMALE
	OTHER
}

enum RiskLevel {
	LOW
	MEDIUM
	HIGH
}

enum PlanStatus {
	DRAFT
	APPROVED
	REJECTED
}

enum SeverityRiskCategory {
	LIFE_THREATENING
	URGENT
	HIGH_RISK
	STANDARD
}

model MedicalKnowledgeEmbedding {
	id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
	content           String   @db.Text
	sourceType        String   @map("source_type")
	sourceId          String?  @map("source_id")
	sourceName        String   @map("source_name")
	metadata          Json     @default("{}")
	severityRelevance String[] @default([]) @map("severity_relevance")
	createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
	updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
	
	@@index([sourceType])
	@@index([sourceId])
	@@map("medical_knowledge_embeddings")
}

model SevereCondition {
	id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
	conditionName       String               @map("condition_name")
	keywords            String[]             @default([])
	vitalThresholds     Json                 @default("{}") @map("vital_thresholds")
	riskCategory        String               @map("risk_category")
	requiredValidations String[]             @default([]) @map("required_validations")
	autoEscalate        Boolean              @default(false) @map("auto_escalate")
	createdAt           DateTime             @default(now()) @map("created_at") @db.Timestamptz
	updatedAt           DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
	
	@@index([riskCategory])
	@@map("severe_conditions")
}
